<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Finalizar Pedido (Checkout)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@700&family=Roboto:wght@400&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <style>
        /* PALETA */
        :root {
            --brand-orange: #D97706;
            --brand-dark: #1F2937;
            --brand-blue: #17a2b8;
            --brand-success: #28a745;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f4f6f8;
        }
        .navbar-brand {
            font-family: 'Roboto Condensed', sans-serif;
            font-weight: 700;
        }

        /* CABECERA Y SECCIÓN DE CONFIANZA */
        .header-checkout {
            background-color: var(--brand-dark);
            color: white;
            padding: 2.5rem 0;
            margin-bottom: 2rem;
            border-bottom: 5px solid var(--brand-orange);
        }

        /* CARD DE RESUMEN (TOTAL) */
        .card-total {
            background-color: #e9ecef;
            border-top: 3px solid var(--brand-orange);
            font-size: 1.25rem;
        }
        .card-total .fw-bolder {
            color: var(--brand-dark);
        }

        /* BOTÓN DE CONFIRMACIÓN DE PAGO (Activa Modal) */
        .btn-confirm {
            background-color: var(--brand-success);
            border-color: var(--brand-success);
            font-weight: 700;
            padding: 10px 20px;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 10px rgba(40, 167, 69, 0.4);
        }
        .btn-confirm:hover {
            background-color: #1e7e34;
            border-color: #1e7e34;
        }

        /* CAMPOS DEL FORMULARIO */
        .form-floating input.form-control {
            height: calc(3.5rem + 2px);
            line-height: 1.25;
        }

        .card-form-body {
            border-left: 5px solid var(--brand-blue);
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
    <div class="container-fluid">
        <a class="navbar-brand" th:href="@{/tienda}"><i class="bi bi-hammer"></i> El Yunque de Hierro</a>
        <a th:href="@{/carrito}" class="btn btn-outline-light"><i class="bi bi-arrow-left"></i> Volver al Carrito</a>
    </div>
</nav>

<div class="header-checkout text-center">
    <div class="container">
        <h1 class="display-5 fw-bold"><i class="bi bi-shield-check"></i> Finalizar Pedido de Compra</h1>
        <p class="lead">Confirma tus datos para proceder al procesamiento del pago seguro.</p>
    </div>
</div>

<div class="container my-5">

    <div th:if="${error}" class="alert alert-danger shadow-sm" th:text="${error}">Error de Stock o Pago</div>

    <div class="row g-4 justify-content-center">

        <div class="col-lg-5 order-lg-2">
            <div class="card shadow-lg h-100">
                <div class="card-header bg-dark text-white fw-bold"><i class="bi bi-card-list"></i> Detalle del Pedido</div>

                <ul class="list-group list-group-flush">
                    <li th:each="item : ${carritoItems}" class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <span th:text="${item.nombreProducto}">Producto X</span>
                            <span class="badge bg-secondary rounded-pill" th:text="'x ' + ${item.cantidad}">x 1</span>
                        </div>
                        <span th:text="${#numbers.formatCurrency(item.subtotal)}">$10.00</span>
                    </li>
                </ul>

                <div class="card-footer card-total fw-bold d-flex justify-content-between">
                    <span>Total a Pagar (IVA Incluido):</span>
                    <span class="fw-bolder" th:text="${#numbers.formatCurrency(totalPedido)}">$50.00</span>
                </div>
            </div>
        </div>

        <div class="col-lg-7 order-lg-1">
            <div class="card shadow-lg p-4 h-100 card-form-body">

                <h4 class="mb-4 fw-bold text-dark"><i class="bi bi-geo-alt"></i> 1. Datos de Envío y Contacto</h4>

                <form id="addressForm" th:action="@{/checkout/procesar}" method="post" th:object="${direccionDTO}">

                    <div class="form-floating mb-3">
                        <input type="text" th:field="*{callePrincipal}" id="callePrincipal" class="form-control" placeholder="Dirección Principal" required>
                        <label for="callePrincipal">Dirección Principal (Calle y Número)</label>
                    </div>

                    <div class="row">
                        <div class="col-md-7 mb-3">
                            <div class="form-floating">
                                <input type="text" th:field="*{ciudad}" id="ciudad" class="form-control" placeholder="Ciudad" required>
                                <label for="ciudad">Ciudad</label>
                            </div>
                        </div>
                        <div class="col-md-5 mb-3">
                            <div class="form-floating">
                                <input type="text" th:field="*{codigoPostal}" id="codigoPostal" class="form-control" placeholder="Código Postal" required>
                                <label for="codigoPostal">Código Postal</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-floating mb-4">
                        <input type="text" th:field="*{referencias}" id="referencias" class="form-control" placeholder="Referencias Adicionales">
                        <label for="referencias">Referencias Adicionales (Ej: Puerta verde, cerca de un parque)</label>
                    </div>

                    <h4 class="mb-4 fw-bold text-dark"><i class="bi bi-credit-card"></i> 2. Procesamiento Final</h4>

                    <button type="button"
                            class="btn btn-confirm btn-lg w-100 mt-2"
                            data-bs-toggle="modal"
                            data-bs-target="#paymentModal">
                        <i class="bi bi-wallet2"></i> CONFIRMAR PEDIDO Y PAGAR
                    </button>

                    <small class="text-muted d-block mt-2 text-center">Tu información está segura. El pago se procesará en el siguiente paso.</small>
                </form>
            </div>
        </div>

    </div>
</div>

<div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title" id="paymentModalLabel"><i class="bi bi-credit-card-fill"></i> Pasarela de Pago Seguro</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted text-center">Simulación de proceso de pago bancario.</p>

                <form id="paymentForm">
                    <div class="mb-3">
                        <label for="cardNumber" class="form-label fw-bold">Número de Tarjeta</label>
                        <input type="text" id="cardNumber" class="form-control" placeholder="XXXX XXXX XXXX XXXX" required pattern="[0-9]{16}">
                    </div>
                    <div class="mb-3">
                        <label for="cardName" class="form-label fw-bold">Nombre en la Tarjeta</label>
                        <input type="text" id="cardName" class="form-control" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="expiry" class="form-label fw-bold">Vencimiento (MM/AA)</label>
                            <input type="text" id="expiry" class="form-control" placeholder="MM/AA" required pattern="(0[1-9]|1[0-2])\/[0-9]{2}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="cvv" class="form-label fw-bold">CVV</label>
                            <input type="text" id="cvv" class="form-control" placeholder="CVC" required pattern="[0-9]{3,4}">
                        </div>
                    </div>

                    <small class="text-secondary d-block mt-3 mb-3 text-center">Monto total: <strong class="text-dark fs-5" th:text="${#numbers.formatCurrency(totalPedido)}"></strong></small>

                    <div class="d-grid">
                        <button type="button" class="btn btn-success btn-lg" onclick="finalizarPago()">
                            <i class="bi bi-credit-card"></i> Pagar Ahora y Finalizar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    function finalizarPago() {
        // 1. Aquí se podría añadir una validación simple del formulario de pago simulado
        // Por ahora, asumiremos que los campos del modal están llenos (ya tienen 'required')

        // 2. Si la simulación es exitosa, cerramos el modal (opcional, el submit lo oculta)
        var paymentModal = bootstrap.Modal.getInstance(document.getElementById('paymentModal'));
        if (paymentModal) {
            paymentModal.hide();
        }

        // 3. ENVIAR el formulario de dirección original (#addressForm)
        // Esto envía los datos de dirección al controller en la ruta /checkout/procesar
        document.getElementById('addressForm').submit();
    }

    // Opcional: Validar el formulario de dirección antes de abrir el modal
    document.getElementById('addressForm').addEventListener('submit', function(event) {
        // Prevenir el envío inmediato si se intenta usar ENTER
        event.preventDefault();

        // Aquí podrías añadir una lógica de validación más robusta si fuera necesario

        // Simular clic en el botón para abrir el modal si la validación pasa
        const addressButton = document.querySelector('#addressForm button[data-bs-toggle="modal"]');
        if (addressButton) {
            new bootstrap.Modal(document.getElementById('paymentModal')).show();
        }
    });

    // Asegurar que el modal solo se abra si la validación HTML de los campos pasa
    document.querySelector('#addressForm button[data-bs-toggle="modal"]').addEventListener('click', function(event) {
        const form = document.getElementById('addressForm');
        // Chequea si el formulario es válido según las reglas HTML5 (required, pattern)
        if (!form.checkValidity()) {
            event.preventDefault(); // Detiene la apertura del modal
            event.stopPropagation();
            form.classList.add('was-validated'); // Muestra los mensajes de error de Bootstrap
        } else {
            form.classList.remove('was-validated');
        }
    }, false);
</script>

</body>
</html>