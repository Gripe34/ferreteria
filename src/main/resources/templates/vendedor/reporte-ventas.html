<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Historial de Ventas - El Yunque de Hierro</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/2.0.8/css/dataTables.bootstrap5.min.css">

    <style>
        /* BASE Y TIPOGRAFA */
        body { font-family: 'Roboto', sans-serif; background-color: #e9ecef; }
        h1, h2 { font-family: 'Poppins', sans-serif; font-weight: 700; color: #212529; }

        /* NAVBAR */
        .navbar-brand { font-weight: 700; font-size: 1.5rem; }

        /* BOTONES DE RETORNO */
        .btn-return-vendedor { background-color: #0d6efd; color: #fff; transition: transform 0.2s; }
        .btn-return-vendedor:hover { background-color: #0b5ed7; transform: translateY(-2px); }

        /* CARD Y TABLA */
        .card-table { border-radius: 12px; overflow: hidden; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); }
        .table-custom th {
            background-color: #343a40;
            color: white;
            font-weight: 600;
            padding: 1rem 1.5rem;
        }
        .table-custom tbody tr:hover {
            background-color: #f0f2f4;
        }

        /* TOTAL GENERAL (LLAMATIVO) */
        .alert-total {
            background: linear-gradient(135deg, #198754, #28a745);
            color: #fff;
            border: none;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 128, 0, 0.3);
            animation: bounceIn 0.8s ease-out;
        }
        .total-count {
            font-size: 3rem;
            font-weight: 700;
            line-height: 1;
            display: block;
            animation: pulse-grow 2s infinite alternate;
        }

        /* BADGES */
        .status-badge { font-size: 0.8em; padding: 0.5em 0.8em; border-radius: 50px; font-weight: 700; }
        .btn-action-pdf { background-color: #dc3545; color: white; border-color: #dc3545; }
        .btn-action-pdf:hover { background-color: #c82333; }

        /* ANIMACIONES */
        @keyframes pulse-grow {
            0% { transform: scale(1); }
            100% { transform: scale(1.03); }
        }
        @keyframes bounceIn {
            0% { opacity: 0; transform: scale(0.9); }
            100% { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
    <div class="container-fluid">
        <a class="navbar-brand" th:href="@{/vendedor/index}"><i class="bi bi-person-workspace"></i> PORTAL DE VENTAS</a>
    </div>
</nav>

<div class="container my-5">

    <div class="d-flex justify-content-between align-items-center mb-5">
        <h1 class="display-5"><i class="bi bi-journal-text me-3 text-primary"></i> Historial General de Ventas</h1>
        <a th:href="@{/vendedor/index}" class="btn btn-lg btn-return-vendedor shadow-sm">
            <i class="bi bi-arrow-left-circle-fill"></i> Volver al Panel
        </a>
    </div>

    <div class="alert alert-total shadow-lg mb-5 p-4">
        <p class="alert-heading fw-normal mb-1">Total de Registros Encontrados:</p>
        <span class="total-count" th:text="${#lists.size(ventas)}">0</span>
        <p class="mb-0 mt-2 small text-light">Utiliza la b煤squeda para filtrar por ID, Cliente, o M茅todo de Pago.</p>
    </div>

    <div class="card card-table shadow-lg">
        <div class="card-body p-0">
            <table id="ventasTabla" class="table table-hover table-custom align-middle mb-0 w-100">
                <thead class="table-dark">
                <tr>
                    <th style="width: 5%;">ID</th>
                    <th style="width: 15%;">Fecha</th>
                    <th style="width: 20%;">Cliente / Vendedor</th>
                    <th style="width: 15%;">M茅todo Pago</th>
                    <th style="width: 15%;" class="text-end">Total</th>
                    <th style="width: 30%;" class="text-center">Acciones</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="venta : ${ventas}">
                    <td th:text="${venta.id}">101</td>

                    <td th:text="${#temporals.format(venta.fechaRegistro, 'dd/MM/yyyy HH:mm')}"></td>

                    <td>
                        <span class="fw-bold" th:text="${venta.clienteNombre ?: 'Consumidor Final'}"></span>
                        <small class="d-block text-muted">Vendedor: <span th:text="${venta.vendedorNombre}"></span></small>
                    </td>

                    <td>
                            <span class="badge status-badge"
                                  th:classappend="${venta.metodoPago == 'TARJETA'} ? 'bg-primary' : 'bg-success'"
                                  th:text="${venta.metodoPago}">EFECTIVO</span>
                    </td>

                    <td class="text-end fw-bold text-success" th:text="${#numbers.formatCurrency(venta.total)}"></td>

                    <td class="text-center">
                        <button type="button" class="btn btn-sm btn-outline-primary me-2"
                                data-bs-toggle="modal"
                                data-bs-target="#detalleVentaModal"
                                th:attr="data-id=${venta.id}"
                                title="Ver detalle">
                            <i class="bi bi-eye"></i> Detalle
                        </button>

                        <a th:href="@{/api/ventas/factura/{id}(id=${venta.id})}" target="_blank"
                           class="btn btn-sm btn-action-pdf" title="Descargar Factura">
                            <i class="bi bi-file-pdf"></i> PDF
                        </a>
                    </td>
                </tr>
                <tr th:if="${#lists.isEmpty(ventas)}">
                    <td colspan="6" class="text-center text-muted fst-italic py-4">No se encontraron ventas registradas.</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="detalleVentaModal" tabindex="-1" aria-labelledby="detalleVentaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
        </div>
    </div>
</div>


<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/2.0.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/2.0.8/js/dataTables.bootstrap5.min.js"></script>

<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function() {

        //  INICIALIZACIN DE DATATABLES (Bloque Protegido contra Thymeleaf)
        /*[-*/
        $('#ventasTabla').DataTable({
            language: { url: '//cdn.datatables.net/plug-ins/2.0.8/i18n/es-ES.json' },
            responsive: true,
            // Sintaxis JSON v谩lida para JavaScript
            order: [[1, 'desc']],
            "lengthMenu": [ [10, 25, 50, -1], [10, 25, 50, "Todos"] ]
        });
        /*-]*/

        //  URL BASE GENERADA POR THYMELEAF (Ruta del Controller)
        const baseUrl = /*[[@{/vendedor/detalle-venta/}]]*/ '/vendedor/detalle-venta/';

        const detalleModalElement = document.getElementById('detalleVentaModal');

        // L贸gica de carga del Modal de Detalle (AJAX)
        detalleModalElement.addEventListener('show.bs.modal', function (event) {

            const button = event.relatedTarget;
            const ventaId = button.getAttribute('data-id');
            const url = baseUrl + ventaId; // Construcci贸n: /vendedor/detalle-venta/123

            const modalContent = detalleModalElement.querySelector('.modal-content');

            // 1. Mostrar Spinner mientras carga
            modalContent.innerHTML = `
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title">Detalle de Venta #${ventaId}</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center p-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-3">Cargando detalles de la transacci贸n...</p>
                </div>
            `;

            // 2. Realizar la petici贸n HTTP para obtener el HTML del detalle (Fragmento)
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error al cargar el detalle: ' + response.statusText);
                    }
                    return response.text();
                })
                .then(html => {
                    // 3. Insertar el contenido HTML (modal-detalle-venta.html) en el modal
                    modalContent.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error al cargar detalle:', error);
                    // Mostrar mensaje de error en el modal
                    modalContent.innerHTML = `
                        <div class="modal-header bg-danger text-white">
                            <h5 class="modal-title">Error de Carga</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body alert alert-danger">
                            No se pudo cargar el detalle de la venta. Verifique que el servicio est茅 activo: ${error.message}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        </div>
                    `;
                });
        });
    });
</script>
</body>
</html>