<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Historial de Compras - El Yunque de Hierro</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css">

    <style>
        /* BASE Y TIPOGRAFA */
        body { font-family: 'Roboto', sans-serif; background-color: #f4f6f8; }
        h1, h2 { font-family: 'Poppins', sans-serif; font-weight: 700; color: #212529; }
        .navbar-brand { font-weight: 700; }
        /* HEADER */
        .header-section {
            background-color: #343a40;
            color: white;
            padding: 2.5rem 0;
            margin-bottom: 2rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        /* TABLA DE DETALLE */
        .card-history { border-radius: 12px; overflow: hidden; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08); }
        .table-custom th {
            font-weight: 600;
            background-color: #343a40 !important;
            color: white;
            padding: 1rem 1.5rem;
        }
        .table-custom td { vertical-align: middle; }
        /* BOTN DE ACCIN */
        .btn-detalle {
            background-color: #17a2b8;
            border-color: #17a2b8;
            transition: transform 0.2s;
            font-weight: 600;
        }
        .btn-detalle:hover {
            background-color: #138496;
            border-color: #138496;
            transform: translateY(-1px);
        }
        /* DATATABLES FOOTER/HEADER */
        .dataTables_wrapper { padding: 1rem; background-color: white; border-radius: 0 0 12px 12px; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
    <div class="container-fluid">
        <a class="navbar-brand" th:href="@{/}"><i class="bi bi-hammer"></i> El Yunque de Hierro</a>
    </div>
</nav>

<div class="header-section text-center">
    <div class="container">
        <h1 class="display-6 fw-bold"><i class="bi bi-box-seam me-2"></i> Historial de Compras</h1>
    </div>
</div>

<div class="container my-5">

    <h2 class="mb-4"><i class="bi bi-list-stars"></i> Tus Pedidos Recientes</h2>

    <div th:if="${misCompras == null or misCompras.isEmpty()}" class="alert alert-info text-center shadow-sm">
        A煤n no has realizado ninguna compra con nosotros. <a th:href="@{/tienda}" class="alert-link fw-bold">隆Ver cat谩logo!</a>
    </div>

    <div th:unless="${misCompras == null or misCompras.isEmpty()}" class="card card-history">
        <div class="card-body p-0">
            <table id="comprasTabla" class="table table-custom table-striped table-hover align-middle mb-0 w-100">
                <thead class="table-dark">
                <tr>
                    <th style="width: 15%;"># Pedido</th>
                    <th style="width: 25%;">Fecha</th>
                    <th style="width: 20%;">Total</th>
                    <th style="width: 25%;">Estado</th>
                    <th style="width: 15%;" class="text-center">Acciones</th>
                </tr>
                </thead>
                <tbody>
                <th:block th:each="compra : ${misCompras}">
                    <tr th:if="${compra != null}">
                        <td th:text="${compra.id}" class="fw-bold">1001</td>

                        <td th:text="${#temporals.format(compra.fechaRegistro, 'dd/MM/yyyy HH:mm')}"
                            th:attr="data-order=${compra.fechaRegistro != null ? #temporals.format(compra.fechaRegistro, 'yyyyMMddHHmmss') : 0}">
                            10/11/2025 15:30
                        </td>

                        <td class="fw-bold text-success" th:text="${#numbers.formatCurrency(compra.total)}">$150.00</td>

                        <td>
                            <span class="badge bg-success" th:text="${compra.estado}">Completado</span>
                        </td>

                        <td class="text-center">
                            <button type="button"
                                    class="btn btn-sm btn-detalle text-white"
                                    th:data-compra-id="${compra.id}">
                                <i class="bi bi-eye"></i> Detalle
                            </button>
                        </td>
                    </tr>
                </th:block>
                </tbody>
            </table>
        </div>
    </div>
</div>


<div class="modal fade" id="detalleCompraModal" tabindex="-1" aria-labelledby="detalleCompraModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="detalleCompraModalLabel">Pedido #<span id="modalPedidoId"></span></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div id="detalleModalContainer">
                <div class="modal-body text-center">
                    <p>Cargando detalles...</p>
                    <div class="spinner-border text-primary" role="status"></div>
                </div>
            </div>

            <div class="modal-footer">
                <a href="#" id="btnImprimirFactura" target="_blank" class="btn btn-warning me-auto">
                    <i class="bi bi-printer"></i> Imprimir
                </a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<div th:fragment="detalleModalContent">
    <div th:if="${compra != null}" class="modal-body">

        <div th:object="${compra}">
            <h6 class="fw-bold text-primary">Informaci贸n General</h6>
            <div class="row mb-3">
                <div class="col-md-6"><strong>Fecha:</strong> <span th:text="${#temporals.format(compra.fechaRegistro, 'dd/MM/yyyy HH:mm')}"></span></div>
                <div class="col-md-6"><strong>Estado:</strong> <span th:text="*{estado}"></span></div>
            </div>
            <div class="row mb-4">
                <div class="col-md-6"><strong>Total Pagado:</strong> <span class="text-success fw-bold" th:text="${#numbers.formatCurrency(compra.total)}"></span></div>
                <div class="col-md-6"><strong>Direcci贸n:</strong> <span th:text="*{direccionEnvio}"></span></div>
            </div>
        </div>

        <h6 class="fw-bold mt-4 text-primary">Productos Comprados</h6>
        <table class="table table-striped table-sm">
            <thead class="table-light">
            <tr><th>Producto</th><th>Cantidad</th><th>Precio Unitario</th></tr>
            </thead>
            <tbody>
            <tr th:each="item : ${compra.detalles}" th:if="${item != null}">
                <td th:text="${item.producto.nombre}"></td>
                <td th:text="${item.cantidad}"></td>
                <td th:text="${#numbers.formatCurrency(item.precioUnitario)}"></td>
            </tr>
            </tbody>
        </table>
    </div>

</div>


<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>

<script>
    /*<![CDATA[*/

    $(document).ready(function() {

        // ==========================================================
        //  INICIALIZACIN DE DATATABLES
        // ==========================================================
        try {
            // Usamos la versi贸n de i18n m谩s reciente, compatible con cualquier versi贸n de DT
            $('#comprasTabla').DataTable({
                language: {
                    url: '//cdn.datatables.net/plug-ins/2.0.8/i18n/es-ES.json'
                },
                responsive: true,
                "lengthMenu": [ [10, 25, 50, -1], [10, 25, 50, "Todos"] ],
                "order": []
            });
        } catch (e) {
            console.error("Error al inicializar DataTables:", e);
        }


        // ==========================================================
        //  LGICA PARA CARGAR EL MODAL DE DETALLE (AJAX)
        // ==========================================================

        $('#comprasTabla').on('click', '.btn-detalle', function(e) {
            e.preventDefault();

            var compraId = $(this).data('compra-id');
            var detailUrl = '/mi-cuenta/detalle-compra/' + compraId; // URL Cr铆tica
            var $modalContainer = $('#detalleModalContainer');

            // 1. Mostrar ID y Spinner
            $('#modalPedidoId').text(compraId);
            $modalContainer.html(`
                <div class="modal-body text-center">
                    <p>Cargando detalles de la compra...</p>
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
            `);

            // 2. Solicitud AJAX
            $.ajax({
                url: detailUrl,
                type: 'GET',
                success: function(fragment) {
                    $modalContainer.html(fragment); // Carga el fragmento HTML
                    $('#btnImprimirFactura').attr('href', '/mi-cuenta/factura/' + compraId);
                },
                error: function(xhr) {
                    // Manejo de errores
                    var status = xhr.status;
                    var errorMessage;

                    if (status === 404) {
                        // El servidor devolvi贸 404: Compra no existe o, MS IMPORTANTE,
                        // el usuario no tiene permiso para verla (error de seguridad).
                        errorMessage = 'Error 404: Compra no encontrada o no autorizada.';
                    } else if (status === 500) {
                        // El servidor devolvi贸 500: Fallo en JPA (Lazy Loading) o error en la plantilla.
                        errorMessage = 'Error 500: Fallo interno del servidor al cargar los detalles.';
                    } else if (status === 403) {
                         errorMessage = 'Error 403: Acceso denegado. (Problema de Spring Security).';
                    } else {
                        errorMessage = 'Error inesperado (' + status + '). Int茅ntalo de nuevo.';
                    }

                    $modalContainer.html(
                        '<div class="modal-body text-danger text-center">' +
                        '<i class="bi bi-exclamation-triangle-fill me-2"></i>' +
                        '<p class="fw-bold">' + errorMessage + '</p>' +
                        '<p class="text-muted small">Verifique el servidor si el problema persiste.</p>' +
                        '</div>'
                    );
                }
            });

            // 3. Mostrar el modal
            var modal = new bootstrap.Modal(document.getElementById('detalleCompraModal'));
            modal.show();
        });

    });
    /*]]>*/
</script>

</body>
</html>